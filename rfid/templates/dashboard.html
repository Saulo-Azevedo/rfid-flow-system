{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFID Flow - Dashboard</title>
    
    <!-- CSS Global -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<!-- ‚úÖ CSS para badges de requalifica√ß√£o OTIMIZADO -->
    <style>
        /* Badges de requalifica√ß√£o mais compactos */
        .badge-requalificacao {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            text-align: center;
        }
        
        .badge-em-dia {
            background: rgba(0, 230, 118, 0.15);
            color: #00E676;
            border: 1px solid rgba(0, 230, 118, 0.3);
        }
        
        .badge-proximo-vencimento {
            background: rgba(255, 214, 0, 0.15);
            color: #FFD600;
            border: 1px solid rgba(255, 214, 0, 0.3);
        }
        
        .badge-vencida {
            background: rgba(255, 61, 0, 0.15);
            color: #FF3D00;
            border: 1px solid rgba(255, 61, 0, 0.3);
        }
        
        .badge-pendente {
            background: rgba(176, 190, 197, 0.15);
            color: #B0BEC5;
            border: 1px solid rgba(176, 190, 197, 0.3);
        }
        
        /* Ajuste da tabela para comportar 9 colunas */
        .table-container table {
            table-layout: auto;
            width: 100%;
        }
        
        .table-container table th,
        .table-container table td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }
        
        /* Colunas espec√≠ficas com larguras fixas */
        .table-container table th:nth-child(1), /* Tag RFID */
        .table-container table td:nth-child(1) {
            max-width: 180px;
        }
        
        .table-container table th:nth-child(5), /* Fabricante */
        .table-container table td:nth-child(5) {
            max-width: 120px;
        }
        
        .table-container table th:nth-child(6), /* Requalifica√ß√£o */
        .table-container table td:nth-child(6) {
            max-width: 140px;
            min-width: 140px;
        }
        
        .table-container table th:nth-child(8), /* Leituras */
        .table-container table td:nth-child(8) {
            max-width: 80px;
            text-align: center;
        }
        
        .table-container table th:nth-child(9), /* √öltima Leitura */
        .table-container table td:nth-child(9) {
            max-width: 130px;
            min-width: 130px;
        }
    </style>



<body>
    <div class="container">
        <!-- Header -->
        <header class="card mb-3 fade-in">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    {% load static %}
                    <img src="{% static 'img/logo.png' %}" 
                         alt="RFID Flow" 
                         style="height: 60px; object-fit: contain;"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div>
                        <h1 style="margin: 0; font-size: 1.8rem;">RFID FLOW</h1>
                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.9rem;">Industry 4.0 - Gest√£o Inteligente de Botij√µes</p>
                    </div>
                </div>
                
                <div class="update-indicator" id="updateIndicator">
                    <div class="pulse-dot"></div>
                    <span>Sistema ativo</span>
                </div>
            </div>
        </header>

 <!-- Actions (movido para baixo do header) -->
        <div class="flex gap-2 mb-3 slide-in" style="flex-wrap: wrap;">
            <a href="{% url 'nova_leitura' %}" class="btn btn-primary">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" x2="12" y1="19" y2="22"></line>
                </svg>
                Nova Leitura
            </a>
            <a href="{% url 'exportar_excel' %}" class="btn btn-success">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" x2="8" y1="13" y2="13"></line>
                    <line x1="16" x2="8" y1="17" y2="17"></line>
                </svg>
                Exportar Excel
            </a>
            <a href="{% url 'enviar_relatorio' %}" class="btn btn-success">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect width="20" height="16" x="2" y="4" rx="2"></rect>
                    <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path>
                </svg>
                Enviar Relat√≥rio
            </a>
            <a href="{% url 'relatorios' %}" class="btn btn-secondary">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" x2="12" y1="20" y2="10"></line>
                    <line x1="18" x2="18" y1="20" y2="4"></line>
                    <line x1="6" x2="6" y1="20" y2="16"></line>
                </svg>
                Relat√≥rios
            </a>
            <a href="{% url 'historico_busca' %}" class="btn btn-outline">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.3-4.3"></path>
                </svg>
                Buscar Hist√≥rico
            </a>
            <a href="/admin/" class="btn btn-outline">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
                Admin
            </a>
            <a href="{% url 'logout' %}" class="btn btn-danger">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" x2="9" y1="12" y2="12"></line>
                </svg>
                Sair
            </a>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid slide-in" style="animation-delay: 0.1s;">
            <div class="stat-card">
                <div class="stat-label">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 6v6l4 2"></path>
                    </svg>
                    Total de Botij√µes
                </div>
                <div class="stat-value" id="totalBotijoes">{{ total_botijoes }}</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle;">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                    </svg>
                    Leituras Hoje
                </div>
                <div class="stat-value" style="background: var(--gradient-secondary); -webkit-background-clip: text; -webkit-text-fill-color: transparent;" id="leiturasHoje">{{ leituras_hoje }}</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    √öltima Leitura
                </div>
                <div class="stat-value" style="font-size: 2rem;" id="ultimaLeitura">{{ ultima_leitura|default:"--:--" }}</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle;">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                    </svg>
                    Botij√µes Ativos
                </div>
                <div class="stat-value" style="color: var(--success);" id="botijoesAtivos">{{ botijoes_ativos }}</div>
            </div>
        </div>

        <!-- Gr√°ficos -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="card fade-in" style="animation-delay: 0.2s;">
                <div class="card-header">
                    <h3 class="card-title">üìä Leituras dos √öltimos 7 Dias</h3>
                </div>
                <canvas id="leiturasChart" style="max-height: 300px;"></canvas>
            </div>
            
            <div class="card fade-in" style="animation-delay: 0.3s;">
                <div class="card-header">
                    <h3 class="card-title">üìà Status dos Botij√µes</h3>
                </div>
                <canvas id="statusChart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <!-- Tabela de Botij√µes -->
        <div class="table-container fade-in" style="animation-delay: 0.4s;">
            <div class="table-header">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                    <rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect>
                </svg>
                √öltimos Botij√µes Cadastrados
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Tag RFID</th>
                        <th>N¬∫ S√©rie</th>
                        <th>Cliente</th>
                        <th>Localiza√ß√£o</th>
                        <th>Fabricante</th>
                        <th>üîç Requalifica√ß√£o</th>
                        <th>Status</th>
                        <th>Leituras</th>
                        <th>√öltima Leitura</th>
                    </tr>
                </thead>
                <tbody id="tabelaBotijoes">
                    {% for botijao in botijoes %}
                    <tr>
                        <td>
                            <a href="{% url 'historico_botijao' botijao.id %}" 
                               style="color: var(--primary); text-decoration: none; font-weight: 600;">
                                {{ botijao.tag_rfid|truncatechars:25 }}
                            </a>
                        </td>
                        <td>
                            <a href="{% url 'historico_botijao' botijao.id %}" 
                               style="color: var(--text-secondary); text-decoration: none;">
                                {{ botijao.numero_serie|default:"-" }}
                            </a>
                        </td>
                        <td>{{ botijao.cliente|default:"-" }}</td>
                        <td>{{ botijao.localizacao|default:"-" }}</td>
                        <td>{{ botijao.fabricante|default:"-" }}</td>
                        <td>
                            <span class="badge-requalificacao badge-{{ botijao.status_requalificacao|default:'pendente' }}">
                                {% if botijao.status_requalificacao == 'em_dia' %}
                                    ‚úÖ Em Dia
                                {% elif botijao.status_requalificacao == 'proximo_vencimento' %}
                                    ‚ö†Ô∏è Pr√≥ximo Vencimento
                                {% elif botijao.status_requalificacao == 'vencida' %}
                                    ‚ùå Vencida
                                {% else %}
                                    ‚è≥ Pendente
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <span class="badge badge-{{ botijao.status }}">
                                {{ botijao.get_status_display }}
                            </span>
                        </td>
                        <td>{{ botijao.total_leituras }}</td>
                        <td>
                            {% if botijao.ultima_leitura %}
                                {{ botijao.ultima_leitura|date:"d/m/Y H:i" }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 60px; color: var(--text-muted);">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 20px; opacity: 0.3;">
                                <rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect>
                                <line x1="9" x2="15" y1="9" y2="9"></line>
                                <line x1="9" x2="15" y1="15" y2="15"></line>
                            </svg>
                            <h3 style="color: var(--text-secondary);">Nenhum botij√£o cadastrado</h3>
                            <p>Comece fazendo uma nova leitura RFID</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // ========== GR√ÅFICOS ==========
        
        // Gr√°fico de Leituras dos √öltimos 7 Dias
        const ctxLeituras = document.getElementById('leiturasChart').getContext('2d');
        const leiturasChart = new Chart(ctxLeituras, {
            type: 'line',
            data: {
                labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'],
                datasets: [{
                    label: 'Leituras',
                    data: [45, 52, 38, 65, 48, 55, 42],
                    borderColor: '#00D4FF',
                    backgroundColor: 'rgba(0, 212, 255, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#00D4FF',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 212, 255, 0.1)'
                        },
                        ticks: {
                            color: '#B0BEC5'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#B0BEC5'
                        }
                    }
                }
            }
        });
        
        // Gr√°fico de Status dos Botij√µes
        const ctxStatus = document.getElementById('statusChart').getContext('2d');
        const statusChart = new Chart(ctxStatus, {
            type: 'doughnut',
            data: {
                labels: ['Ativos', 'Inativos', 'Manuten√ß√£o'],
                datasets: [{
                    data: [{{ botijoes_ativos }}, 
                           {{ total_botijoes|add:"-"|add:botijoes_ativos }}, 
                           0],
                    backgroundColor: [
                        '#00E676',
                        '#FF3D00',
                        '#FFD600'
                    ],
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#B0BEC5',
                            padding: 20,
                            font: {
                                size: 12
                            }
                        }
                    }
                }
            }
        });
        
        // ========== AJAX - ATUALIZA√á√ÉO AUTOM√ÅTICA ==========
        
        async function atualizarDados() {
            const indicator = document.getElementById('updateIndicator');
            const dot = indicator.querySelector('.pulse-dot');
            const text = indicator.querySelector('span');
            
            try {
                indicator.classList.add('updating');
                text.textContent = 'Atualizando...';
                
                const response = await fetch('{% url "dashboard_api" %}');
                const data = await response.json();
                
                // Atualiza os cards
                document.getElementById('totalBotijoes').textContent = data.total_botijoes;
                document.getElementById('leiturasHoje').textContent = data.leituras_hoje;
                document.getElementById('ultimaLeitura').textContent = data.ultima_leitura;
                document.getElementById('botijoesAtivos').textContent = data.botijoes_ativos;
                
                // Atualiza a tabela
                const tbody = document.getElementById('tabelaBotijoes');
                
                if (data.botijoes.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 60px; color: var(--text-muted);">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 20px; opacity: 0.3;">
                                    <rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect>
                                    <line x1="9" x2="15" y1="9" y2="9"></line>
                                    <line x1="9" x2="15" y1="15" y2="15"></line>
                                </svg>
                                <h3 style="color: var(--text-secondary);">Nenhum botij√£o cadastrado</h3>
                                <p>Comece fazendo uma nova leitura RFID</p>
                            </td>
                        </tr>
                    `;
                } else {
                    tbody.innerHTML = data.botijoes.map(b => {
                        // Determina o badge de requalifica√ß√£o
                        let badgeRequalificacao = '';
                        if (b.status_requalificacao === 'em_dia') {
                            badgeRequalificacao = '<span class="badge-requalificacao badge-em-dia">‚úÖ Em Dia</span>';
                        } else if (b.status_requalificacao === 'proximo_vencimento') {
                            badgeRequalificacao = '<span class="badge-requalificacao badge-proximo-vencimento">‚ö†Ô∏è Pr√≥ximo Vencimento</span>';
                        } else if (b.status_requalificacao === 'vencida') {
                            badgeRequalificacao = '<span class="badge-requalificacao badge-vencida">‚ùå Vencida</span>';
                        } else {
                            badgeRequalificacao = '<span class="badge-requalificacao badge-pendente">‚è≥ Pendente</span>';
                        }
                        
                        return `
                            <tr>
                                <td>
                                    <a href="/botijao/${b.id}/historico/" 
                                       style="color: var(--primary); text-decoration: none; font-weight: 600;">
                                        ${b.tag_rfid}
                                    </a>
                                </td>
                                <td>
                                    <a href="/botijao/${b.id}/historico/" 
                                       style="color: var(--text-secondary); text-decoration: none;">
                                        ${b.numero_serie}
                                    </a>
                                </td>
                                <td>${b.cliente}</td>
                                <td>${b.localizacao}</td>
                                <td>${b.fabricante || '-'}</td>
                                <td>${badgeRequalificacao}</td>
                                <td>
                                    <span class="badge badge-${b.status}">
                                        ${b.status_display}
                                    </span>
                                </td>
                                <td>${b.total_leituras}</td>
                                <td>${b.ultima_leitura}</td>
                            </tr>
                        `;
                    }).join('');
                }
                
                indicator.classList.remove('updating');
                text.textContent = 'Sistema ativo';
                
            } catch (error) {
                console.error('Erro ao atualizar:', error);
                text.textContent = 'Erro na atualiza√ß√£o';
            }
        }
        
        // Atualiza a cada 3 segundos
        setInterval(atualizarDados, 3000);
        setTimeout(atualizarDados, 3000);
    </script>
</body>
</html>